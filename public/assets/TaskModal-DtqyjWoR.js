import{I as oe,r as h,k as m,G as $,c as y,a as o,o as p,B as P,s as ae,x as le,l as q,f as re,g as ne,b as z,w as G,t as B,d as M,J as ie,v as W,p as te,m as se,F as J,z as K,D as Q,T as ue,C as de,j as ce}from"./index-C49xSu61.js";import{u as Y}from"./workspace-EsO4VE_8.js";import{_ as ve}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Fe=oe("tasks",()=>{const r=h([]),f=h(!1),b=h(!1),k=h(localStorage.getItem("taskViewMode")||"list"),g=h(new Set),j=Y(),I=m(()=>j.selectedWorkspaces.map(e=>e.id)),w=m(()=>{const e=I.value;return e.length?r.value.filter(l=>e.includes(l.workspace_id)):[]}),x=m(()=>w.value.filter(e=>e.status==="inbox")),O=m(()=>w.value.filter(e=>e.status==="next_action")),T=m(()=>w.value.filter(e=>e.status==="today")),V=m(()=>w.value.filter(e=>e.status==="tomorrow")),a=m(()=>w.value.filter(e=>e.status==="waiting")),n=m(()=>w.value.filter(e=>e.status==="someday")),u=m(()=>w.value.filter(e=>e.status==="scheduled")),d=m(()=>({inbox:x.value.length,next_actions:O.value.length,today:T.value.length,tomorrow:V.value.length,waiting:a.value.length,someday:n.value.length,scheduled:u.value.length})),_=(e,l)=>w.value.filter(i=>{if(!i.due_date)return!1;const c=i.due_date.substring(0,10);return c>=e&&c<=l}),C=async({force:e=!1}={})=>{var l;if(!(b.value&&!e)){f.value=!0;try{const i=await $.get("/v1/tasks");r.value=((l=i.data.data)==null?void 0:l.tasks)||i.data.tasks||i.data||[],b.value=!0}finally{f.value=!1}}},D=e=>{const l={...e};return l.estimated_time===""&&(l.estimated_time=null),l.due_date===""&&(l.due_date=null),l.description===""&&(l.description=null),(l.project_id===""||l.project_id===null)&&(l.project_id=null),l},U=async e=>{var S;const l=(e==null?void 0:e.workspace_id)||((S=j.currentWorkspace)==null?void 0:S.id);if(!l){console.error("Cannot create task: workspace_id not found");return}const i=D(e);i.workspace_id=l;const c=await $.post(`/v1/workspaces/${l}/tasks`,i),v=c.data.data||c.data;return v.status!=="completed"&&r.value.unshift(v),v},E=async(e,l)=>{var ee;const i=r.value.find(R=>R.id===e),c=(i==null?void 0:i.workspace_id)||(l==null?void 0:l.workspace_id)||((ee=j.currentWorkspace)==null?void 0:ee.id);if(!c){console.error("Cannot update task: workspace_id not found");return}const v=D(l);delete v.workspace_id;const S=await $.put(`/v1/workspaces/${c}/tasks/${e}`,v),Z=S.data.data||S.data,N=r.value.findIndex(R=>R.id===e);return N!==-1&&(Z.status==="completed"?r.value.splice(N,1):r.value[N]=Z),Z},A=async e=>{var c;const l=r.value.find(v=>v.id===e),i=(l==null?void 0:l.workspace_id)||((c=j.currentWorkspace)==null?void 0:c.id);if(!i){console.error("Cannot complete task: workspace_id not found");return}g.value=new Set([...g.value,e]);try{await $.post(`/v1/workspaces/${i}/tasks/${e}/complete`),setTimeout(()=>{r.value=r.value.filter(S=>S.id!==e);const v=new Set(g.value);v.delete(e),g.value=v},600)}catch(v){const S=new Set(g.value);throw S.delete(e),g.value=S,v}},F=async e=>{var c;const l=r.value.find(v=>v.id===e),i=(l==null?void 0:l.workspace_id)||((c=j.currentWorkspace)==null?void 0:c.id);if(!i){console.error("Cannot delete task: workspace_id not found");return}await $.delete(`/v1/workspaces/${i}/tasks/${e}`),r.value=r.value.filter(v=>v.id!==e)},H=e=>{k.value=e,localStorage.setItem("taskViewMode",e)};let L=null;return{allTasks:r,loading:f,loaded:b,completingTaskIds:g,filteredTasks:w,inboxTasks:x,nextActionTasks:O,todayTasks:T,tomorrowTasks:V,waitingTasks:a,somedayTasks:n,scheduledTasks:u,counts:d,calendarTasks:_,viewMode:k,fetchAllTasks:C,createTask:U,updateTask:E,completeTask:A,deleteTask:F,setViewMode:H,startSync:()=>{L=setInterval(()=>C({force:!0}),5*60*1e3)},stopSync:()=>{L&&clearInterval(L)}}}),pe=oe("projects",()=>{const r=h([]),f=h(!1),b=Y(),k=m(()=>{var n;return(n=b.currentWorkspace)==null?void 0:n.id}),g=async(n=!1)=>{if(k.value){f.value=!0;try{const u=n?{include_archived:!0}:{},d=await $.get(`/v1/workspaces/${k.value}/projects`,{params:u});r.value=d.data.data||d.data||[]}finally{f.value=!1}}},j=async n=>{if(k.value){f.value=!0;try{const u=await $.get(`/v1/workspaces/${k.value}/projects/${n}`);return u.data.data||u.data}finally{f.value=!1}}},I=async n=>{if(!k.value)return;const u=await $.post(`/v1/workspaces/${k.value}/projects`,n),d=u.data.data||u.data;return r.value.push(d),d},w=async(n,u)=>{if(!k.value)return;const d=await $.put(`/v1/workspaces/${k.value}/projects/${n}`,u),_=d.data.data||d.data,C=r.value.findIndex(D=>D.id===n);return C!==-1&&(r.value[C]=_),_},x=async n=>await w(n,{status:"archived"}),O=async n=>await w(n,{status:"active"}),T=async n=>{k.value&&(await $.delete(`/v1/workspaces/${k.value}/projects/${n}`),r.value=r.value.filter(u=>u.id!==n))},V=m(()=>r.value.filter(n=>n.status==="active"||!n.status)),a=m(()=>r.value.filter(n=>n.status==="archived"));return{projects:r,activeProjects:V,archivedProjects:a,loading:f,fetchProjects:g,fetchProject:j,createProject:I,updateProject:w,archiveProject:x,unarchiveProject:O,deleteProject:T}});function me(r,f){return p(),y("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m20.25 7.5-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z"})])}function fe(r,f){return p(),y("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m3.75 13.5 10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75Z"})])}function X(r,f){return p(),y("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5"})])}function we(r,f){return p(),y("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"})])}function ke(r,f){return p(),y("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M2.25 13.5h3.86a2.25 2.25 0 0 1 2.012 1.244l.256.512a2.25 2.25 0 0 0 2.013 1.244h3.218a2.25 2.25 0 0 0 2.013-1.244l.256-.512a2.25 2.25 0 0 1 2.013-1.244h3.859m-19.5.338V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18v-4.162c0-.224-.034-.447-.1-.661L19.24 5.338a2.25 2.25 0 0 0-2.15-1.588H6.911a2.25 2.25 0 0 0-2.15 1.588L2.35 13.177a2.25 2.25 0 0 0-.1.661Z"})])}const ge={class:"flex min-h-screen items-center justify-center p-4"},ye={class:"flex items-center justify-between p-6 border-b border-gray-200"},be={class:"text-xl font-semibold text-gray-900"},xe={class:"flex items-center space-x-3 pb-4 border-b border-gray-200"},_e={class:"flex items-center space-x-2 cursor-pointer"},he={class:"text-sm font-medium text-gray-700"},je={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Se={class:"relative"},$e={class:"flex items-center space-x-2"},Ce={key:0,class:"absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-lg shadow-lg"},Me=["onClick"],Te={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Ve={key:0},Be=["value"],Pe=["value"],Ie={key:1,class:"text-red-600 text-sm bg-red-50 p-3 rounded-lg"},Oe={class:"flex justify-end space-x-3 pt-4"},De=["disabled"],Ue={__name:"TaskModal",props:{show:{type:Boolean,default:!1},task:{type:Object,default:null},serverError:{type:String,default:""}},emits:["close","submit"],setup(r,{emit:f}){const b=r,k=f,g=ce(),j=Y(),I=pe(),w=m(()=>j.workspaces),x=m(()=>j.currentWorkspace),O=m(()=>I.activeProjects),T=()=>{const s=g.path;return s.includes("/inbox")?"inbox":s.includes("/today")?"today":s.includes("/next-actions")?"next_action":s.includes("/tomorrow")?"tomorrow":s.includes("/waiting")?"waiting":s.includes("/someday")?"someday":"inbox"},V=()=>{const s=g.path;if(s.includes("/today"))return new Date().toISOString().split("T")[0];if(s.includes("/tomorrow")){const t=new Date;return t.setDate(t.getDate()+1),t.toISOString().split("T")[0]}return""},a=h({title:"",description:"",status:"inbox",priority:"medium",due_date:"",estimated_time:"",end_time:"",workspace_id:null,project_id:null}),n=h(!1),u=h(""),d=h(!1),_=h(null),C={inbox:{label:"Входящие",icon:ke},next_action:{label:"Следующие",icon:fe},today:{label:"Сегодня",icon:X},tomorrow:{label:"Завтра",icon:X},waiting:{label:"Ожидание",icon:we},someday:{label:"Когда-нибудь",icon:me},scheduled:{label:"Запланировано",icon:X}},D=s=>{if(a.value.status=s,d.value=!1,s==="today"){const t=new Date;a.value.due_date=t.toISOString().split("T")[0]}else if(s==="tomorrow"){const t=new Date;t.setDate(t.getDate()+1),a.value.due_date=t.toISOString().split("T")[0]}},U=m(()=>a.value.status==="completed"),E=s=>{s.target.checked?a.value.status!=="completed"&&(_.value=a.value.status,a.value.status="completed"):(a.value.status=_.value||"inbox",_.value=null)},A=s=>s?/^\d{4}-\d{2}-\d{2}$/.test(s)?s:s.split("T")[0]:"",F=s=>s?/^\d{2}:\d{2}$/.test(s)?s:s.substring(0,5):"";P(()=>b.task,(s,t)=>{var e,l,i;if(t&&!s){a.value={title:"",description:"",status:"inbox",priority:"medium",due_date:"",estimated_time:"",end_time:"",workspace_id:(e=x.value)==null?void 0:e.id,project_id:null},_.value=null,u.value="",d.value=!1;return}if(s)console.log("Task received:",s),console.log("Original due_date:",s.due_date),console.log("Formatted due_date:",A(s.due_date)),s.status==="completed"?_.value=s.previous_status||"inbox":_.value=s.status||"inbox",a.value={title:s.title||"",description:s.description||"",status:s.status||"inbox",priority:s.priority||"medium",due_date:A(s.due_date),estimated_time:F(s.estimated_time),end_time:F(s.end_time),workspace_id:s.workspace_id||((l=x.value)==null?void 0:l.id),project_id:s.project_id||null};else{const c=T();_.value=c,a.value={title:"",description:"",status:c,priority:"medium",due_date:V(),estimated_time:"",end_time:"",workspace_id:(i=x.value)==null?void 0:i.id,project_id:null}}u.value="",d.value=!1},{immediate:!0}),P(()=>b.serverError,s=>{u.value=s,s&&(n.value=!1)}),P(()=>b.show,s=>{var t,e,l;s?b.task?a.value.workspace_id||(a.value.workspace_id=(e=x.value)==null?void 0:e.id):(a.value.workspace_id=(t=x.value)==null?void 0:t.id,a.value.status=T(),a.value.due_date=V()):(a.value={title:"",description:"",status:"inbox",priority:"medium",due_date:"",estimated_time:"",end_time:"",workspace_id:(l=x.value)==null?void 0:l.id,project_id:null},_.value=null,d.value=!1,n.value=!1,u.value="")}),P(()=>b.show,s=>{var t;s&&((t=x.value)!=null&&t.id)&&I.fetchProjects()}),P(()=>g.path,()=>{if(!b.task){a.value.status=T();const s=V();(s||g.path.includes("/today"))&&(a.value.due_date=s)}}),P(()=>{var s;return(s=x.value)==null?void 0:s.id},s=>{!b.task&&s&&(a.value.workspace_id=s)}),P(()=>a.value.due_date,s=>{if(!s||a.value.status==="completed")return;const t=new Date().toISOString().split("T")[0],e=new Date;e.setDate(e.getDate()+1);const l=e.toISOString().split("T")[0];s===t?a.value.status="today":s===l?a.value.status="tomorrow":["today","tomorrow","completed"].includes(a.value.status)||(a.value.status="scheduled")});const H=()=>{u.value="",n.value=!0,k("submit",a.value)},L=s=>{d.value&&!s.target.closest(".relative")&&(d.value=!1)};return ae(()=>{document.addEventListener("click",L)}),le(()=>{document.removeEventListener("click",L)}),(s,t)=>(p(),q(de,{to:"body"},[re(ue,{name:"modal"},{default:ne(()=>[r.show?(p(),y("div",{key:0,class:"fixed inset-0 z-50 overflow-y-auto",onClick:t[13]||(t[13]=G(e=>s.$emit("close"),["self"]))},[t[27]||(t[27]=o("div",{class:"fixed inset-0 bg-black bg-opacity-50 transition-opacity"},null,-1)),o("div",ge,[o("div",{class:"relative bg-white rounded-lg shadow-xl max-w-2xl w-full mx-auto",onClick:t[12]||(t[12]=G(()=>{},["stop"]))},[o("div",ye,[o("h3",be,B(r.task?"Редактировать задачу":"Новая задача"),1),o("button",{onClick:t[0]||(t[0]=e=>s.$emit("close")),class:"text-gray-400 hover:text-gray-600"},[...t[14]||(t[14]=[o("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),o("form",{onSubmit:G(H,["prevent"]),class:"p-6 space-y-4"},[o("div",xe,[o("label",_e,[M(o("input",{type:"checkbox","onUpdate:modelValue":t[1]||(t[1]=e=>U.value=e),onChange:E,class:"w-5 h-5 text-primary-600 border-gray-300 rounded focus:ring-primary-500"},null,544),[[ie,U.value]]),o("span",he,B(U.value?"Задача выполнена":"Отметить как выполненную"),1)])]),o("div",null,[t[15]||(t[15]=o("label",{for:"title",class:"block text-sm font-medium text-gray-700 mb-2"}," Название задачи * ",-1)),M(o("input",{id:"title","onUpdate:modelValue":t[2]||(t[2]=e=>a.value.title=e),type:"text",required:"",class:te(["input",{"opacity-60":U.value}]),placeholder:"Введите название задачи"},null,2),[[W,a.value.title]])]),o("div",null,[t[16]||(t[16]=o("label",{for:"description",class:"block text-sm font-medium text-gray-700 mb-2"}," Описание ",-1)),M(o("textarea",{id:"description","onUpdate:modelValue":t[3]||(t[3]=e=>a.value.description=e),rows:"3",class:"input",placeholder:"Добавьте описание"},null,512),[[W,a.value.description]])]),o("div",je,[o("div",null,[t[18]||(t[18]=o("label",{for:"status",class:"block text-sm font-medium text-gray-700 mb-2"}," Статус ",-1)),o("div",Se,[o("button",{type:"button",onClick:t[4]||(t[4]=e=>d.value=!d.value),class:"input w-full flex items-center justify-between"},[o("span",$e,[(p(),q(se(C[a.value.status].icon),{class:"w-5 h-5 text-gray-500"})),o("span",null,B(C[a.value.status].label),1)]),t[17]||(t[17]=o("svg",{class:"w-5 h-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"})],-1))]),d.value?(p(),y("div",Ce,[(p(),y(J,null,K(C,(e,l)=>o("button",{key:l,type:"button",onClick:i=>D(l),class:te(["w-full flex items-center space-x-2 px-3 py-2 text-sm hover:bg-gray-50 first:rounded-t-lg last:rounded-b-lg transition-colors",a.value.status===l?"bg-primary-50 text-primary-700":"text-gray-700"])},[(p(),q(se(e.icon),{class:"w-5 h-5"})),o("span",null,B(e.label),1)],10,Me)),64))])):z("",!0)])]),o("div",null,[t[20]||(t[20]=o("label",{for:"priority",class:"block text-sm font-medium text-gray-700 mb-2"}," Приоритет ",-1)),M(o("select",{id:"priority","onUpdate:modelValue":t[5]||(t[5]=e=>a.value.priority=e),class:"input"},[...t[19]||(t[19]=[o("option",{value:"low"},"Низкий",-1),o("option",{value:"medium"},"Средний",-1),o("option",{value:"high"},"Высокий",-1),o("option",{value:"urgent"},"Срочный",-1)])],512),[[Q,a.value.priority]])])]),o("div",Te,[o("div",null,[t[21]||(t[21]=o("label",{for:"due_date",class:"block text-sm font-medium text-gray-700 mb-2"}," Срок выполнения ",-1)),M(o("input",{id:"due_date","onUpdate:modelValue":t[6]||(t[6]=e=>a.value.due_date=e),type:"date",class:"input"},null,512),[[W,a.value.due_date]])]),o("div",null,[t[22]||(t[22]=o("label",{for:"estimated_time",class:"block text-sm font-medium text-gray-700 mb-2"}," Время начала ",-1)),M(o("input",{id:"estimated_time","onUpdate:modelValue":t[7]||(t[7]=e=>a.value.estimated_time=e),type:"time",class:"input",placeholder:"12:30"},null,512),[[W,a.value.estimated_time]])])]),o("div",null,[t[23]||(t[23]=o("label",{for:"end_time",class:"block text-sm font-medium text-gray-700 mb-2"}," Время окончания ",-1)),M(o("input",{id:"end_time","onUpdate:modelValue":t[8]||(t[8]=e=>a.value.end_time=e),type:"time",class:"input",placeholder:"13:30"},null,512),[[W,a.value.end_time]])]),w.value.length>1?(p(),y("div",Ve,[t[24]||(t[24]=o("label",{for:"workspace_id",class:"block text-sm font-medium text-gray-700 mb-2"}," Рабочее пространство ",-1)),M(o("select",{id:"workspace_id","onUpdate:modelValue":t[9]||(t[9]=e=>a.value.workspace_id=e),class:"input"},[(p(!0),y(J,null,K(w.value,e=>(p(),y("option",{key:e.id,value:e.id},B(e.name),9,Be))),128))],512),[[Q,a.value.workspace_id]])])):z("",!0),o("div",null,[t[26]||(t[26]=o("label",{for:"project_id",class:"block text-sm font-medium text-gray-700 mb-2"}," Проект ",-1)),M(o("select",{id:"project_id","onUpdate:modelValue":t[10]||(t[10]=e=>a.value.project_id=e),class:"input"},[t[25]||(t[25]=o("option",{value:null},"Без проекта",-1)),(p(!0),y(J,null,K(O.value,e=>(p(),y("option",{key:e.id,value:e.id},B(e.name),9,Pe))),128))],512),[[Q,a.value.project_id]])]),u.value?(p(),y("div",Ie,B(u.value),1)):z("",!0),o("div",Oe,[o("button",{type:"button",onClick:t[11]||(t[11]=e=>s.$emit("close")),class:"btn btn-secondary"}," Отмена "),o("button",{type:"submit",disabled:n.value,class:"btn btn-primary"},B(n.value?"Сохранение...":"Сохранить"),9,De)])],32)])])])):z("",!0)]),_:1})]))}},ze=ve(Ue,[["__scopeId","data-v-97b0fe88"]]);export{ze as T,we as a,X as b,fe as c,ke as d,pe as e,me as r,Fe as u};
