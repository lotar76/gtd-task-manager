import{H as se,r as S,k as p,I as j,c as w,a,o as v,B,s as ae,x as oe,l as R,f as re,g as le,b as F,w as q,t as I,d as C,J as ne,v as A,p as ee,m as te,F as J,A as K,D as G,T as ie,C as de,j as ue}from"./index-CnWhnmF9.js";import{u as X}from"./workspace-BbrdbZpc.js";import{_ as ce}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ae=se("tasks",()=>{const l=S([]),c=S(!1),m=S(!1),y=S(localStorage.getItem("taskViewMode")||"list"),x=X(),L=p(()=>x.selectedWorkspaces.map(e=>e.id)),k=p(()=>{const e=L.value;return e.length?l.value.filter(t=>e.includes(t.workspace_id)):[]}),P=p(()=>k.value.filter(e=>e.status==="inbox")),b=p(()=>k.value.filter(e=>e.status==="next_action")),M=p(()=>k.value.filter(e=>e.status==="today")),T=p(()=>k.value.filter(e=>e.status==="tomorrow")),V=p(()=>k.value.filter(e=>e.status==="waiting")),o=p(()=>k.value.filter(e=>e.status==="someday")),$=p(()=>k.value.filter(e=>e.status==="scheduled")),_=p(()=>({inbox:P.value.length,next_actions:b.value.length,today:M.value.length,tomorrow:T.value.length,waiting:V.value.length,someday:o.value.length,scheduled:$.value.length})),r=(e,t)=>k.value.filter(s=>{if(!s.due_date)return!1;const i=s.due_date.substring(0,10);return i>=e&&i<=t}),n=async({force:e=!1}={})=>{var t;if(!(m.value&&!e)){c.value=!0;try{const s=await j.get("/v1/tasks");l.value=((t=s.data.data)==null?void 0:t.tasks)||s.data.tasks||s.data||[],m.value=!0}finally{c.value=!1}}},d=e=>{const t={...e};return t.estimated_time===""&&(t.estimated_time=null),t.due_date===""&&(t.due_date=null),t.description===""&&(t.description=null),(t.project_id===""||t.project_id===null)&&(t.project_id=null),t},u=async e=>{var h;const t=(e==null?void 0:e.workspace_id)||((h=x.currentWorkspace)==null?void 0:h.id);if(!t){console.error("Cannot create task: workspace_id not found");return}const s=d(e);s.workspace_id=t;const i=await j.post(`/v1/workspaces/${t}/tasks`,s),f=i.data.data||i.data;return f.status!=="completed"&&l.value.unshift(f),f},g=async(e,t)=>{var Y;const s=l.value.find(N=>N.id===e),i=(s==null?void 0:s.workspace_id)||(t==null?void 0:t.workspace_id)||((Y=x.currentWorkspace)==null?void 0:Y.id);if(!i){console.error("Cannot update task: workspace_id not found");return}const f=d(t);delete f.workspace_id;const h=await j.put(`/v1/workspaces/${i}/tasks/${e}`,f),W=h.data.data||h.data,Z=l.value.findIndex(N=>N.id===e);return Z!==-1&&(W.status==="completed"?l.value.splice(Z,1):l.value[Z]=W),W},O=async e=>{var h;const t=l.value.findIndex(W=>W.id===e);if(t===-1)return;const s=l.value[t],i=s.workspace_id||((h=x.currentWorkspace)==null?void 0:h.id);if(!i){console.error("Cannot complete task: workspace_id not found");return}const f={...s};l.value.splice(t,1);try{await j.post(`/v1/workspaces/${i}/tasks/${e}/complete`)}catch(W){throw l.value.splice(t,0,f),W}},D=async e=>{var i;const t=l.value.find(f=>f.id===e),s=(t==null?void 0:t.workspace_id)||((i=x.currentWorkspace)==null?void 0:i.id);if(!s){console.error("Cannot delete task: workspace_id not found");return}await j.delete(`/v1/workspaces/${s}/tasks/${e}`),l.value=l.value.filter(f=>f.id!==e)},E=e=>{y.value=e,localStorage.setItem("taskViewMode",e)};let U=null;return{allTasks:l,loading:c,loaded:m,filteredTasks:k,inboxTasks:P,nextActionTasks:b,todayTasks:M,tomorrowTasks:T,waitingTasks:V,somedayTasks:o,scheduledTasks:$,counts:_,calendarTasks:r,viewMode:y,fetchAllTasks:n,createTask:u,updateTask:g,completeTask:O,deleteTask:D,setViewMode:E,startSync:()=>{U=setInterval(()=>n({force:!0}),5*60*1e3)},stopSync:()=>{U&&clearInterval(U)}}}),pe=se("projects",()=>{const l=S([]),c=S(!1),m=X(),y=p(()=>{var r;return(r=m.currentWorkspace)==null?void 0:r.id}),x=p(()=>m.selectedWorkspaces.map(r=>r.id)),L=async(r=!1)=>{if(y.value){c.value=!0;try{const n=r?{include_archived:!0}:{},d=await j.get(`/v1/workspaces/${y.value}/projects`,{params:n});l.value=d.data.data||d.data||[]}finally{c.value=!1}}},k=async(r=!1)=>{if(x.value.length!==0){c.value=!0;try{const n=r?{include_archived:!0}:{},d=await Promise.all(x.value.map(u=>j.get(`/v1/workspaces/${u}/projects`,{params:n}).then(g=>({workspace_id:u,projects:g.data.data||g.data||[]})).catch(g=>(console.error(`Error fetching projects for workspace ${u}:`,g),{workspace_id:u,projects:[]}))));l.value=d.flatMap(u=>u.projects)}finally{c.value=!1}}},P=async r=>{if(y.value){c.value=!0;try{const n=await j.get(`/v1/workspaces/${y.value}/projects/${r}`);return n.data.data||n.data}finally{c.value=!1}}},b=async r=>{const n=r.workspace_id||y.value;if(!n)return;const d=await j.post(`/v1/workspaces/${n}/projects`,r),u=d.data.data||d.data;return l.value.push(u),u},M=async(r,n)=>{const d=n.workspace_id||y.value;if(!d)return;const u=await j.put(`/v1/workspaces/${d}/projects/${r}`,n),g=u.data.data||u.data,O=l.value.findIndex(D=>D.id===r);return O!==-1&&(l.value[O]=g),g},T=async r=>{const n=l.value.find(d=>d.id===r);return await M(r,{workspace_id:n==null?void 0:n.workspace_id,status:"archived"})},V=async r=>{const n=l.value.find(d=>d.id===r);return await M(r,{workspace_id:n==null?void 0:n.workspace_id,status:"active"})},o=async r=>{const n=l.value.find(u=>u.id===r),d=(n==null?void 0:n.workspace_id)||y.value;d&&(await j.delete(`/v1/workspaces/${d}/projects/${r}`),l.value=l.value.filter(u=>u.id!==r))},$=p(()=>l.value.filter(r=>r.status==="active"||!r.status)),_=p(()=>l.value.filter(r=>r.status==="archived"));return{projects:l,activeProjects:$,archivedProjects:_,loading:c,fetchProjects:L,fetchProjectsForSelectedWorkspaces:k,fetchProject:P,createProject:b,updateProject:M,archiveProject:T,unarchiveProject:V,deleteProject:o}});function ve(l,c){return v(),w("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m20.25 7.5-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z"})])}function me(l,c){return v(),w("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m3.75 13.5 10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75Z"})])}function Q(l,c){return v(),w("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5"})])}function fe(l,c){return v(),w("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"})])}function ke(l,c){return v(),w("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M2.25 13.5h3.86a2.25 2.25 0 0 1 2.012 1.244l.256.512a2.25 2.25 0 0 0 2.013 1.244h3.218a2.25 2.25 0 0 0 2.013-1.244l.256-.512a2.25 2.25 0 0 1 2.013-1.244h3.859m-19.5.338V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18v-4.162c0-.224-.034-.447-.1-.661L19.24 5.338a2.25 2.25 0 0 0-2.15-1.588H6.911a2.25 2.25 0 0 0-2.15 1.588L2.35 13.177a2.25 2.25 0 0 0-.1.661Z"})])}const ge={class:"flex min-h-screen items-center justify-center p-4"},we={class:"flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700"},ye={class:"text-xl font-semibold text-gray-900 dark:text-white"},xe={class:"flex items-center space-x-3 pb-4 border-b border-gray-200 dark:border-gray-700"},be={class:"flex items-center space-x-2 cursor-pointer"},_e={class:"text-sm font-medium text-gray-700 dark:text-gray-300"},he={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},je={class:"relative"},Se={class:"flex items-center space-x-2"},$e={key:0,class:"absolute z-10 mt-1 w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg"},Ce=["onClick"],Me={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Te={key:0},Ve=["value"],Ie=["value"],Pe={key:1,class:"text-red-600 dark:text-red-400 text-sm bg-red-50 dark:bg-red-900/20 p-3 rounded-lg"},We={class:"flex justify-end space-x-3 pt-4"},Be=["disabled"],Le={__name:"TaskModal",props:{show:{type:Boolean,default:!1},task:{type:Object,default:null},serverError:{type:String,default:""},defaultDate:{type:String,default:""}},emits:["close","submit"],setup(l,{emit:c}){const m=l,y=c,x=ue(),L=X(),k=pe(),P=p(()=>L.workspaces),b=p(()=>L.currentWorkspace),M=p(()=>k.activeProjects),T=()=>{const e=x.path;return e.includes("/inbox")?"inbox":e.includes("/today")?"today":e.includes("/next-actions")?"next_action":e.includes("/tomorrow")?"tomorrow":e.includes("/waiting")?"waiting":e.includes("/someday")?"someday":"inbox"},V=()=>{const e=x.path;if(e.includes("/today"))return new Date().toISOString().split("T")[0];if(e.includes("/tomorrow")){const t=new Date;return t.setDate(t.getDate()+1),t.toISOString().split("T")[0]}return""},o=S({title:"",description:"",status:"inbox",priority:"medium",due_date:"",estimated_time:"",end_time:"",workspace_id:null,project_id:null}),$=S(!1),_=S(""),r=S(!1),n=S(null),d={inbox:{label:"Входящие",icon:ke},next_action:{label:"Следующие",icon:me},today:{label:"Сегодня",icon:Q},tomorrow:{label:"Завтра",icon:Q},waiting:{label:"Ожидание",icon:fe},someday:{label:"Когда-нибудь",icon:ve},scheduled:{label:"Запланировано",icon:Q}},u=e=>{if(o.value.status=e,r.value=!1,e==="today"){const t=new Date;o.value.due_date=t.toISOString().split("T")[0]}else if(e==="tomorrow"){const t=new Date;t.setDate(t.getDate()+1),o.value.due_date=t.toISOString().split("T")[0]}},g=p(()=>o.value.status==="completed"),O=e=>{e.target.checked?o.value.status!=="completed"&&(n.value=o.value.status,o.value.status="completed"):(o.value.status=n.value||"inbox",n.value=null)},D=e=>e?/^\d{4}-\d{2}-\d{2}$/.test(e)?e:e.split("T")[0]:"",E=e=>e?/^\d{2}:\d{2}$/.test(e)?e:e.substring(0,5):"";B(()=>m.task,(e,t)=>{var s,i,f;if(t&&!e){o.value={title:"",description:"",status:"inbox",priority:"medium",due_date:"",estimated_time:"",end_time:"",workspace_id:(s=b.value)==null?void 0:s.id,project_id:null},n.value=null,_.value="",r.value=!1;return}if(e)console.log("Task received:",e),console.log("Original due_date:",e.due_date),console.log("Formatted due_date:",D(e.due_date)),e.status==="completed"?n.value=e.previous_status||"inbox":n.value=e.status||"inbox",o.value={title:e.title||"",description:e.description||"",status:e.status||"inbox",priority:e.priority||"medium",due_date:D(e.due_date),estimated_time:E(e.estimated_time),end_time:E(e.end_time),workspace_id:e.workspace_id||((i=b.value)==null?void 0:i.id),project_id:e.project_id||null};else{const h=T();n.value=h,o.value={title:"",description:"",status:h,priority:"medium",due_date:V(),estimated_time:"",end_time:"",workspace_id:(f=b.value)==null?void 0:f.id,project_id:null}}_.value="",r.value=!1},{immediate:!0}),B(()=>m.serverError,e=>{_.value=e,e&&($.value=!1)}),B(()=>m.show,e=>{var t,s,i;e?m.task?o.value.workspace_id||(o.value.workspace_id=(s=b.value)==null?void 0:s.id):(o.value.workspace_id=(t=b.value)==null?void 0:t.id,o.value.status=T(),o.value.due_date=m.defaultDate||V()):(o.value={title:"",description:"",status:"inbox",priority:"medium",due_date:"",estimated_time:"",end_time:"",workspace_id:(i=b.value)==null?void 0:i.id,project_id:null},n.value=null,r.value=!1,$.value=!1,_.value="")}),B(()=>m.show,e=>{var t;e&&((t=b.value)!=null&&t.id)&&k.fetchProjects()}),B(()=>x.path,()=>{if(!m.task){o.value.status=T();const e=V();(e||x.path.includes("/today"))&&(o.value.due_date=e)}}),B(()=>{var e;return(e=b.value)==null?void 0:e.id},e=>{!m.task&&e&&(o.value.workspace_id=e)}),B(()=>o.value.due_date,e=>{if(!e||o.value.status==="completed")return;const t=new Date().toISOString().split("T")[0],s=new Date;s.setDate(s.getDate()+1);const i=s.toISOString().split("T")[0];e===t?o.value.status="today":e===i?o.value.status="tomorrow":["today","tomorrow","completed"].includes(o.value.status)||(o.value.status="scheduled")});const U=()=>{_.value="",$.value=!0,y("submit",o.value)},H=e=>{r.value&&!e.target.closest(".relative")&&(r.value=!1)},z=e=>{e.key==="Escape"&&m.show&&y("close")};return ae(()=>{document.addEventListener("click",H),document.addEventListener("keydown",z)}),oe(()=>{document.removeEventListener("click",H),document.removeEventListener("keydown",z)}),(e,t)=>(v(),R(de,{to:"body"},[re(ie,{name:"modal"},{default:le(()=>[l.show?(v(),w("div",{key:0,class:"fixed inset-0 z-50 overflow-y-auto",onClick:t[13]||(t[13]=q(s=>e.$emit("close"),["self"]))},[t[27]||(t[27]=a("div",{class:"fixed inset-0 bg-black bg-opacity-50 transition-opacity"},null,-1)),a("div",ge,[a("div",{class:"relative bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-auto",onClick:t[12]||(t[12]=q(()=>{},["stop"]))},[a("div",we,[a("h3",ye,I(l.task?"Редактировать задачу":"Новая задача"),1),a("button",{onClick:t[0]||(t[0]=s=>e.$emit("close")),class:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"},[...t[14]||(t[14]=[a("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),a("form",{onSubmit:q(U,["prevent"]),class:"p-6 space-y-4"},[a("div",xe,[a("label",be,[C(a("input",{type:"checkbox","onUpdate:modelValue":t[1]||(t[1]=s=>g.value=s),onChange:O,class:"w-5 h-5 text-primary-600 border-gray-300 dark:border-gray-600 rounded focus:ring-primary-500 dark:bg-gray-700"},null,544),[[ne,g.value]]),a("span",_e,I(g.value?"Задача выполнена":"Отметить как выполненную"),1)])]),a("div",null,[t[15]||(t[15]=a("label",{for:"title",class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"}," Название задачи * ",-1)),C(a("input",{id:"title","onUpdate:modelValue":t[2]||(t[2]=s=>o.value.title=s),type:"text",required:"",class:ee(["input",{"opacity-60":g.value}]),placeholder:"Введите название задачи"},null,2),[[A,o.value.title]])]),a("div",null,[t[16]||(t[16]=a("label",{for:"description",class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"}," Описание ",-1)),C(a("textarea",{id:"description","onUpdate:modelValue":t[3]||(t[3]=s=>o.value.description=s),rows:"3",class:"input",placeholder:"Добавьте описание"},null,512),[[A,o.value.description]])]),a("div",he,[a("div",null,[t[18]||(t[18]=a("label",{for:"status",class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"}," Статус ",-1)),a("div",je,[a("button",{type:"button",onClick:t[4]||(t[4]=s=>r.value=!r.value),class:"input w-full flex items-center justify-between"},[a("span",Se,[(v(),R(te(d[o.value.status].icon),{class:"w-5 h-5 text-gray-500 dark:text-gray-400"})),a("span",null,I(d[o.value.status].label),1)]),t[17]||(t[17]=a("svg",{class:"w-5 h-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"})],-1))]),r.value?(v(),w("div",$e,[(v(),w(J,null,K(d,(s,i)=>a("button",{key:i,type:"button",onClick:f=>u(i),class:ee(["w-full flex items-center space-x-2 px-3 py-2 text-sm hover:bg-gray-50 dark:hover:bg-gray-600 first:rounded-t-lg last:rounded-b-lg transition-colors",o.value.status===i?"bg-primary-50 dark:bg-primary-900/30 text-primary-700 dark:text-primary-400":"text-gray-700 dark:text-gray-300"])},[(v(),R(te(s.icon),{class:"w-5 h-5"})),a("span",null,I(s.label),1)],10,Ce)),64))])):F("",!0)])]),a("div",null,[t[20]||(t[20]=a("label",{for:"priority",class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"}," Приоритет ",-1)),C(a("select",{id:"priority","onUpdate:modelValue":t[5]||(t[5]=s=>o.value.priority=s),class:"input"},[...t[19]||(t[19]=[a("option",{value:"low"},"Низкий",-1),a("option",{value:"medium"},"Средний",-1),a("option",{value:"high"},"Высокий",-1),a("option",{value:"urgent"},"Срочный",-1)])],512),[[G,o.value.priority]])])]),a("div",Me,[a("div",null,[t[21]||(t[21]=a("label",{for:"due_date",class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"}," Срок выполнения ",-1)),C(a("input",{id:"due_date","onUpdate:modelValue":t[6]||(t[6]=s=>o.value.due_date=s),type:"date",class:"input"},null,512),[[A,o.value.due_date]])]),a("div",null,[t[22]||(t[22]=a("label",{for:"estimated_time",class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"}," Время начала ",-1)),C(a("input",{id:"estimated_time","onUpdate:modelValue":t[7]||(t[7]=s=>o.value.estimated_time=s),type:"time",class:"input",placeholder:"12:30"},null,512),[[A,o.value.estimated_time]])])]),a("div",null,[t[23]||(t[23]=a("label",{for:"end_time",class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"}," Время окончания ",-1)),C(a("input",{id:"end_time","onUpdate:modelValue":t[8]||(t[8]=s=>o.value.end_time=s),type:"time",class:"input",placeholder:"13:30"},null,512),[[A,o.value.end_time]])]),P.value.length>1?(v(),w("div",Te,[t[24]||(t[24]=a("label",{for:"workspace_id",class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"}," Рабочее пространство ",-1)),C(a("select",{id:"workspace_id","onUpdate:modelValue":t[9]||(t[9]=s=>o.value.workspace_id=s),class:"input"},[(v(!0),w(J,null,K(P.value,s=>(v(),w("option",{key:s.id,value:s.id},I(s.name),9,Ve))),128))],512),[[G,o.value.workspace_id]])])):F("",!0),a("div",null,[t[26]||(t[26]=a("label",{for:"project_id",class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"}," Проект ",-1)),C(a("select",{id:"project_id","onUpdate:modelValue":t[10]||(t[10]=s=>o.value.project_id=s),class:"input"},[t[25]||(t[25]=a("option",{value:null},"Без проекта",-1)),(v(!0),w(J,null,K(M.value,s=>(v(),w("option",{key:s.id,value:s.id},I(s.name),9,Ie))),128))],512),[[G,o.value.project_id]])]),_.value?(v(),w("div",Pe,I(_.value),1)):F("",!0),a("div",We,[a("button",{type:"button",onClick:t[11]||(t[11]=s=>e.$emit("close")),class:"btn btn-secondary"}," Отмена "),a("button",{type:"submit",disabled:$.value,class:"btn btn-primary"},I($.value?"Сохранение...":"Сохранить"),9,Be)])],32)])])])):F("",!0)]),_:1})]))}},Ee=ce(Le,[["__scopeId","data-v-3cea71c5"]]);export{Ee as T,fe as a,Q as b,me as c,ke as d,pe as e,ve as r,Ae as u};
