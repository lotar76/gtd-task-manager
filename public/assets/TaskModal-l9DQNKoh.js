import{H as Q,r as _,k as $,G as g,c as x,o as w,a as s,z as I,q as X,s as Y,l as E,f as ee,g as te,b as F,w as H,t as C,d as j,I as ae,v as O,p as J,m as K,F as z,y as N,B as Z,T as se,A as oe,j as le}from"./index-C8nfUhJg.js";import{u as q}from"./workspace-B-XDxAs_.js";import{_ as re}from"./_plugin-vue_export-helper-DlAUqK2U.js";const We=Q("tasks",()=>{const n=_([]),d=_(!1),b=_({inbox:0,next_actions:0,today:0,tomorrow:0,waiting:0,someday:0,scheduled:0}),y=_(localStorage.getItem("taskViewMode")||"list"),S=_({status:null,projectId:null,myTasks:!1}),M=q(),m=$(()=>M.selectedWorkspaces.map(l=>l.id)),h=$(()=>{var l;return(l=M.currentWorkspace)==null?void 0:l.id}),k=async(l,r={})=>{if(m.value.length===0)return[];const i=m.value.map(e=>g.get(`/v1/workspaces/${e}/${l}`,{params:r}).then(a=>a.data).catch(a=>(console.error(`Error fetching from workspace ${e}:`,a),[])));return(await Promise.all(i)).flat()},W=async(l=!1)=>{if(m.value.length!==0){d.value=!0;try{const r=l?{my_tasks:!0}:{};n.value=await k("inbox",r)}finally{d.value=!1}}},P=async(l=!1)=>{if(m.value.length!==0){d.value=!0;try{const r=l?{my_tasks:!0}:{};n.value=await k("next-actions",r)}finally{d.value=!1}}},V=async(l=!1)=>{if(m.value.length!==0){d.value=!0;try{const r=l?{my_tasks:!0}:{};n.value=await k("waiting",r)}finally{d.value=!1}}},o=async(l=!1)=>{if(m.value.length!==0){d.value=!0;try{const r=l?{my_tasks:!0}:{};n.value=await k("someday",r)}finally{d.value=!1}}},u=async(l=!1)=>{if(m.value.length!==0){d.value=!0;try{const r=l?{my_tasks:!0}:{},i=await Promise.all(m.value.map(t=>g.get(`/v1/workspaces/${t}/today`,{params:r}).then(e=>e.data.data||e.data||[]).catch(()=>[])));n.value=i.flat()}finally{d.value=!1}}},p=async(l=!1)=>{if(m.value.length!==0){d.value=!0;try{const r=l?{my_tasks:!0}:{},i=await Promise.all(m.value.map(t=>g.get(`/v1/workspaces/${t}/tomorrow`,{params:r}).then(e=>e.data.data||e.data||[]).catch(()=>[])));n.value=i.flat()}finally{d.value=!1}}},v=async(l,r,i=!1)=>{if(m.value.length!==0){d.value=!0;try{const t={start_date:l,end_date:r};i&&(t.my_tasks=!0);const e=await Promise.all(m.value.map(a=>g.get(`/v1/workspaces/${a}/calendar`,{params:t}).then(c=>c.data.data||c.data||[]).catch(()=>[])));n.value=e.flat()}finally{d.value=!1}}},f=async(l=!1)=>{if(m.value.length!==0)try{const r=l?{my_tasks:!0}:{},i=m.value.map(e=>g.get(`/v1/workspaces/${e}/counts`,{params:r}).then(a=>a.data).catch(()=>({inbox:0,next_actions:0,today:0,tomorrow:0,waiting:0,someday:0,scheduled:0}))),t=await Promise.all(i);b.value=t.reduce((e,a)=>({inbox:e.inbox+(a.inbox||0),next_actions:e.next_actions+(a.next_actions||0),today:e.today+(a.today||0),tomorrow:e.tomorrow+(a.tomorrow||0),waiting:e.waiting+(a.waiting||0),someday:e.someday+(a.someday||0),scheduled:e.scheduled+(a.scheduled||0)}),{inbox:0,next_actions:0,today:0,tomorrow:0,waiting:0,someday:0,scheduled:0})}catch(r){console.error("Ошибка при получении счетчиков задач:",r)}};return{tasks:n,loading:d,counts:b,viewMode:y,filter:S,fetchInbox:W,fetchNextActions:P,fetchWaiting:V,fetchSomeday:o,fetchToday:u,fetchTomorrow:p,fetchCalendar:v,fetchCounts:f,createTask:async l=>{const r=(l==null?void 0:l.workspace_id)||h.value;if(!r){console.error("Cannot create task: workspace_id not found");return}const i={...l};i.estimated_time===""&&(i.estimated_time=null),i.due_date===""&&(i.due_date=null),i.description===""&&(i.description=null),(i.project_id===""||i.project_id===null)&&(i.project_id=null),i.workspace_id=r;const t=await g.post(`/v1/workspaces/${r}/tasks`,i);return n.value.unshift(t.data),await f(),t.data},updateTask:async(l,r)=>{var a;const i=n.value.find(c=>c.id===l);let t=i==null?void 0:i.workspace_id;if(t||(t=(r==null?void 0:r.workspace_id)||h.value),!t){console.error("Cannot update task: workspace_id not found");return}const e={...r};delete e.workspace_id,e.estimated_time===""&&(e.estimated_time=null),e.due_date===""&&(e.due_date=null),(e.project_id===""||e.project_id===null)&&(e.project_id=null),console.log("Updating task with data:",e);try{const c=await g.put(`/v1/workspaces/${t}/tasks/${l}`,e),U=n.value.findIndex(A=>A.id===l);return U!==-1&&(n.value[U]=c.data),await f(),c.data}catch(c){throw console.error("Update task error:",(a=c.response)==null?void 0:a.data),c}},completeTask:async l=>{const r=n.value.find(a=>a.id===l),i=(r==null?void 0:r.workspace_id)||h.value;if(!i){console.error("Cannot complete task: workspace_id not found");return}const t=await g.post(`/v1/workspaces/${i}/tasks/${l}/complete`),e=n.value.findIndex(a=>a.id===l);return e!==-1&&(n.value[e]=t.data),await f(),t.data},deleteTask:async l=>{const r=n.value.find(t=>t.id===l),i=(r==null?void 0:r.workspace_id)||h.value;if(!i){console.error("Cannot delete task: workspace_id not found");return}await g.delete(`/v1/workspaces/${i}/tasks/${l}`),n.value=n.value.filter(t=>t.id!==l),await f()},setViewMode:l=>{y.value=l,localStorage.setItem("taskViewMode",l)}}}),ne=Q("projects",()=>{const n=_([]),d=_(!1),b=q(),y=$(()=>{var u;return(u=b.currentWorkspace)==null?void 0:u.id}),S=async(u=!1)=>{if(y.value){d.value=!0;try{const p=u?{include_archived:!0}:{},v=await g.get(`/v1/workspaces/${y.value}/projects`,{params:p});n.value=v.data.data||v.data||[]}finally{d.value=!1}}},M=async u=>{if(y.value){d.value=!0;try{const p=await g.get(`/v1/workspaces/${y.value}/projects/${u}`);return p.data.data||p.data}finally{d.value=!1}}},m=async u=>{if(!y.value)return;const p=await g.post(`/v1/workspaces/${y.value}/projects`,u),v=p.data.data||p.data;return n.value.push(v),v},h=async(u,p)=>{if(!y.value)return;const v=await g.put(`/v1/workspaces/${y.value}/projects/${u}`,p),f=v.data.data||v.data,B=n.value.findIndex(L=>L.id===u);return B!==-1&&(n.value[B]=f),f},k=async u=>await h(u,{status:"archived"}),W=async u=>await h(u,{status:"active"}),P=async u=>{y.value&&(await g.delete(`/v1/workspaces/${y.value}/projects/${u}`),n.value=n.value.filter(p=>p.id!==u))},V=$(()=>n.value.filter(u=>u.status==="active"||!u.status)),o=$(()=>n.value.filter(u=>u.status==="archived"));return{projects:n,activeProjects:V,archivedProjects:o,loading:d,fetchProjects:S,fetchProject:M,createProject:m,updateProject:h,archiveProject:k,unarchiveProject:W,deleteProject:P}});function ie(n,d){return w(),x("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m20.25 7.5-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z"})])}function ue(n,d){return w(),x("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m3.75 13.5 10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75Z"})])}function R(n,d){return w(),x("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5"})])}function de(n,d){return w(),x("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"})])}function ce(n,d){return w(),x("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M2.25 13.5h3.86a2.25 2.25 0 0 1 2.012 1.244l.256.512a2.25 2.25 0 0 0 2.013 1.244h3.218a2.25 2.25 0 0 0 2.013-1.244l.256-.512a2.25 2.25 0 0 1 2.013-1.244h3.859m-19.5.338V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18v-4.162c0-.224-.034-.447-.1-.661L19.24 5.338a2.25 2.25 0 0 0-2.15-1.588H6.911a2.25 2.25 0 0 0-2.15 1.588L2.35 13.177a2.25 2.25 0 0 0-.1.661Z"})])}const pe={class:"flex min-h-screen items-center justify-center p-4"},ve={class:"flex items-center justify-between p-6 border-b border-gray-200"},me={class:"text-xl font-semibold text-gray-900"},fe={class:"flex items-center space-x-3 pb-4 border-b border-gray-200"},we={class:"flex items-center space-x-2 cursor-pointer"},ye={class:"text-sm font-medium text-gray-700"},ke={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},ge={class:"relative"},xe={class:"flex items-center space-x-2"},be={key:0,class:"absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-lg shadow-lg"},_e=["onClick"],he={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},je={key:0},$e=["value"],Se=["value"],Ce={key:1,class:"text-red-600 text-sm bg-red-50 p-3 rounded-lg"},Me={class:"flex justify-end space-x-3 pt-4"},Pe=["disabled"],Ve={__name:"TaskModal",props:{show:{type:Boolean,default:!1},task:{type:Object,default:null},serverError:{type:String,default:""}},emits:["close","submit"],setup(n,{emit:d}){const b=n,y=d,S=le(),M=q(),m=ne(),h=$(()=>M.workspaces),k=$(()=>M.currentWorkspace),W=$(()=>m.activeProjects),P=()=>{const t=S.path;return t.includes("/inbox")?"inbox":t.includes("/today")?"today":t.includes("/next-actions")?"next_action":t.includes("/tomorrow")?"tomorrow":t.includes("/waiting")?"waiting":t.includes("/someday")?"someday":"inbox"},V=()=>S.path.includes("/today")?new Date().toISOString().split("T")[0]:"",o=_({title:"",description:"",status:"inbox",priority:"medium",due_date:"",estimated_time:"",end_time:"",workspace_id:null,project_id:null}),u=_(!1),p=_(""),v=_(!1),f=_(null),B={inbox:{label:"Входящие",icon:ce},next_action:{label:"Следующие",icon:ue},today:{label:"Сегодня",icon:R},tomorrow:{label:"Завтра",icon:R},waiting:{label:"Ожидание",icon:de},someday:{label:"Когда-нибудь",icon:ie},scheduled:{label:"Запланировано",icon:R}},L=t=>{if(o.value.status=t,v.value=!1,t==="today"){const e=new Date;o.value.due_date=e.toISOString().split("T")[0]}else if(t==="tomorrow"){const e=new Date;e.setDate(e.getDate()+1),o.value.due_date=e.toISOString().split("T")[0]}},T=$(()=>o.value.status==="completed"),G=t=>{t.target.checked?o.value.status!=="completed"&&(f.value=o.value.status,o.value.status="completed"):(o.value.status=f.value||"inbox",f.value=null)},D=t=>t?/^\d{4}-\d{2}-\d{2}$/.test(t)?t:t.split("T")[0]:"",l=t=>t?/^\d{2}:\d{2}$/.test(t)?t:t.substring(0,5):"";I(()=>b.task,(t,e)=>{var a,c,U;if(e&&!t){o.value={title:"",description:"",status:"inbox",priority:"medium",due_date:"",estimated_time:"",end_time:"",workspace_id:(a=k.value)==null?void 0:a.id,project_id:null},f.value=null,p.value="",v.value=!1;return}if(t)console.log("Task received:",t),console.log("Original due_date:",t.due_date),console.log("Formatted due_date:",D(t.due_date)),t.status==="completed"?f.value=t.previous_status||"inbox":f.value=t.status||"inbox",o.value={title:t.title||"",description:t.description||"",status:t.status||"inbox",priority:t.priority||"medium",due_date:D(t.due_date),estimated_time:l(t.estimated_time),end_time:l(t.end_time),workspace_id:t.workspace_id||((c=k.value)==null?void 0:c.id),project_id:t.project_id||null};else{const A=P();f.value=A,o.value={title:"",description:"",status:A,priority:"medium",due_date:V(),estimated_time:"",end_time:"",workspace_id:(U=k.value)==null?void 0:U.id,project_id:null}}p.value="",v.value=!1},{immediate:!0}),I(()=>b.serverError,t=>{p.value=t,t&&(u.value=!1)}),I(()=>b.show,t=>{var e,a,c;t?b.task?o.value.workspace_id||(o.value.workspace_id=(a=k.value)==null?void 0:a.id):(o.value.workspace_id=(e=k.value)==null?void 0:e.id,o.value.status=P(),o.value.due_date=V()):(o.value={title:"",description:"",status:"inbox",priority:"medium",due_date:"",estimated_time:"",end_time:"",workspace_id:(c=k.value)==null?void 0:c.id,project_id:null},f.value=null,v.value=!1,u.value=!1,p.value="")}),I(()=>b.show,t=>{var e;t&&((e=k.value)!=null&&e.id)&&m.fetchProjects()}),I(()=>S.path,()=>{if(!b.task){o.value.status=P();const t=V();(t||S.path.includes("/today"))&&(o.value.due_date=t)}}),I(()=>{var t;return(t=k.value)==null?void 0:t.id},t=>{!b.task&&t&&(o.value.workspace_id=t)}),I(()=>o.value.due_date,t=>{if(!t||o.value.status==="completed")return;const e=new Date().toISOString().split("T")[0],a=new Date;a.setDate(a.getDate()+1);const c=a.toISOString().split("T")[0];t===e?o.value.status="today":t===c?o.value.status="tomorrow":["today","tomorrow","completed"].includes(o.value.status)||(o.value.status="scheduled")});const r=()=>{p.value="",u.value=!0,y("submit",o.value)},i=t=>{v.value&&!t.target.closest(".relative")&&(v.value=!1)};return X(()=>{document.addEventListener("click",i)}),Y(()=>{document.removeEventListener("click",i)}),(t,e)=>(w(),E(oe,{to:"body"},[ee(se,{name:"modal"},{default:te(()=>[n.show?(w(),x("div",{key:0,class:"fixed inset-0 z-50 overflow-y-auto",onClick:e[13]||(e[13]=H(a=>t.$emit("close"),["self"]))},[e[27]||(e[27]=s("div",{class:"fixed inset-0 bg-black bg-opacity-50 transition-opacity"},null,-1)),s("div",pe,[s("div",{class:"relative bg-white rounded-lg shadow-xl max-w-2xl w-full mx-auto",onClick:e[12]||(e[12]=H(()=>{},["stop"]))},[s("div",ve,[s("h3",me,C(n.task?"Редактировать задачу":"Новая задача"),1),s("button",{onClick:e[0]||(e[0]=a=>t.$emit("close")),class:"text-gray-400 hover:text-gray-600"},[...e[14]||(e[14]=[s("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),s("form",{onSubmit:H(r,["prevent"]),class:"p-6 space-y-4"},[s("div",fe,[s("label",we,[j(s("input",{type:"checkbox","onUpdate:modelValue":e[1]||(e[1]=a=>T.value=a),onChange:G,class:"w-5 h-5 text-primary-600 border-gray-300 rounded focus:ring-primary-500"},null,544),[[ae,T.value]]),s("span",ye,C(T.value?"Задача выполнена":"Отметить как выполненную"),1)])]),s("div",null,[e[15]||(e[15]=s("label",{for:"title",class:"block text-sm font-medium text-gray-700 mb-2"}," Название задачи * ",-1)),j(s("input",{id:"title","onUpdate:modelValue":e[2]||(e[2]=a=>o.value.title=a),type:"text",required:"",class:J(["input",{"opacity-60":T.value}]),placeholder:"Введите название задачи"},null,2),[[O,o.value.title]])]),s("div",null,[e[16]||(e[16]=s("label",{for:"description",class:"block text-sm font-medium text-gray-700 mb-2"}," Описание ",-1)),j(s("textarea",{id:"description","onUpdate:modelValue":e[3]||(e[3]=a=>o.value.description=a),rows:"3",class:"input",placeholder:"Добавьте описание"},null,512),[[O,o.value.description]])]),s("div",ke,[s("div",null,[e[18]||(e[18]=s("label",{for:"status",class:"block text-sm font-medium text-gray-700 mb-2"}," Статус ",-1)),s("div",ge,[s("button",{type:"button",onClick:e[4]||(e[4]=a=>v.value=!v.value),class:"input w-full flex items-center justify-between"},[s("span",xe,[(w(),E(K(B[o.value.status].icon),{class:"w-5 h-5 text-gray-500"})),s("span",null,C(B[o.value.status].label),1)]),e[17]||(e[17]=s("svg",{class:"w-5 h-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"})],-1))]),v.value?(w(),x("div",be,[(w(),x(z,null,N(B,(a,c)=>s("button",{key:c,type:"button",onClick:U=>L(c),class:J(["w-full flex items-center space-x-2 px-3 py-2 text-sm hover:bg-gray-50 first:rounded-t-lg last:rounded-b-lg transition-colors",o.value.status===c?"bg-primary-50 text-primary-700":"text-gray-700"])},[(w(),E(K(a.icon),{class:"w-5 h-5"})),s("span",null,C(a.label),1)],10,_e)),64))])):F("",!0)])]),s("div",null,[e[20]||(e[20]=s("label",{for:"priority",class:"block text-sm font-medium text-gray-700 mb-2"}," Приоритет ",-1)),j(s("select",{id:"priority","onUpdate:modelValue":e[5]||(e[5]=a=>o.value.priority=a),class:"input"},[...e[19]||(e[19]=[s("option",{value:"low"},"Низкий",-1),s("option",{value:"medium"},"Средний",-1),s("option",{value:"high"},"Высокий",-1),s("option",{value:"urgent"},"Срочный",-1)])],512),[[Z,o.value.priority]])])]),s("div",he,[s("div",null,[e[21]||(e[21]=s("label",{for:"due_date",class:"block text-sm font-medium text-gray-700 mb-2"}," Срок выполнения ",-1)),j(s("input",{id:"due_date","onUpdate:modelValue":e[6]||(e[6]=a=>o.value.due_date=a),type:"date",class:"input"},null,512),[[O,o.value.due_date]])]),s("div",null,[e[22]||(e[22]=s("label",{for:"estimated_time",class:"block text-sm font-medium text-gray-700 mb-2"}," Время начала ",-1)),j(s("input",{id:"estimated_time","onUpdate:modelValue":e[7]||(e[7]=a=>o.value.estimated_time=a),type:"time",class:"input",placeholder:"12:30"},null,512),[[O,o.value.estimated_time]])])]),s("div",null,[e[23]||(e[23]=s("label",{for:"end_time",class:"block text-sm font-medium text-gray-700 mb-2"}," Время окончания ",-1)),j(s("input",{id:"end_time","onUpdate:modelValue":e[8]||(e[8]=a=>o.value.end_time=a),type:"time",class:"input",placeholder:"13:30"},null,512),[[O,o.value.end_time]])]),h.value.length>1?(w(),x("div",je,[e[24]||(e[24]=s("label",{for:"workspace_id",class:"block text-sm font-medium text-gray-700 mb-2"}," Рабочее пространство ",-1)),j(s("select",{id:"workspace_id","onUpdate:modelValue":e[9]||(e[9]=a=>o.value.workspace_id=a),class:"input"},[(w(!0),x(z,null,N(h.value,a=>(w(),x("option",{key:a.id,value:a.id},C(a.name),9,$e))),128))],512),[[Z,o.value.workspace_id]])])):F("",!0),s("div",null,[e[26]||(e[26]=s("label",{for:"project_id",class:"block text-sm font-medium text-gray-700 mb-2"}," Проект ",-1)),j(s("select",{id:"project_id","onUpdate:modelValue":e[10]||(e[10]=a=>o.value.project_id=a),class:"input"},[e[25]||(e[25]=s("option",{value:null},"Без проекта",-1)),(w(!0),x(z,null,N(W.value,a=>(w(),x("option",{key:a.id,value:a.id},C(a.name),9,Se))),128))],512),[[Z,o.value.project_id]])]),p.value?(w(),x("div",Ce,C(p.value),1)):F("",!0),s("div",Me,[s("button",{type:"button",onClick:e[11]||(e[11]=a=>t.$emit("close")),class:"btn btn-secondary"}," Отмена "),s("button",{type:"submit",disabled:u.value,class:"btn btn-primary"},C(u.value?"Сохранение...":"Сохранить"),9,Pe)])],32)])])])):F("",!0)]),_:1})]))}},Te=re(Ve,[["__scopeId","data-v-5b858641"]]);export{Te as T,de as a,R as b,ue as c,ce as d,ne as e,ie as r,We as u};
